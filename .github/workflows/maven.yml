name: Update Jira Fix Versions from Tag

on:
  push:
    tags:
      - 'v*'  # Âè™Â∞ç v1.0.0 ÈÄôÈ°û tag ÁîüÊïà

jobs:
  update-jira:
    runs-on: ubuntu-latest
    steps:
      - name: Get Jira Issue Keys from commit message and update Fix Versions
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "üß∑ Tag: $TAG_NAME"

          # ÂèñÂæó tag Â∞çÊáâÁöÑ commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "üìÑ Commit message: $COMMIT_MSG"

          # Êì∑ÂèñÊâÄÊúâÁ¨¶ÂêàÊ†ºÂºèÁöÑ Jira ÂñÆËôüÔºàÂ§ßÂØ´Â≠óÊØç-Êï∏Â≠óÔºâ
          ISSUE_KEYS=$(echo "$COMMIT_MSG" | grep -oE '[A-Z]+-[0-9]+' | sort -u)

          if [ -z "$ISSUE_KEYS" ]; then
            echo "‚ö†Ô∏è No Jira issue keys found in commit message. Exiting."
            exit 0
          fi

          for ISSUE_KEY in $ISSUE_KEYS; do
            echo "üîß Processing Jira issue: $ISSUE_KEY"

            PROJECT_KEY="${ISSUE_KEY%%-*}"

            # ÂòóË©¶Âª∫Á´ãÁâàÊú¨ÔºàËã•Â∑≤Â≠òÂú®ÊúÉÂ§±Êïó‰ΩÜÁÑ°ÂÆ≥Ôºâ
            curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X POST \
              -H "Content-Type: application/json" \
              --data "{\"name\":\"$TAG_NAME\",\"project\":\"$PROJECT_KEY\"}" \
              "$JIRA_BASE_URL/rest/api/3/version" > /dev/null

            # Êõ¥Êñ∞ Fix Version Ê¨Ñ‰Ωç
            curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X PUT \
              -H "Content-Type: application/json" \
              --data "{\"fields\":{\"fixVersions\":[{\"name\":\"$TAG_NAME\"}]}}" \
              "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY"

            echo "‚úÖ Updated $ISSUE_KEY with fixVersion: $TAG_NAME"
          done
