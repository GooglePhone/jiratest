name: Update Jira Fix Versions from Tag

on:
  push:
    tags:
      - '*' 

jobs:
  update-jira:
    runs-on: ubuntu-latest

    env:
      VERSION_NAME_PREFIX: "adminapi - "

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Jira Issue Keys from commit message and update Fix Versions
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          FIX_VERSION="${VERSION_NAME_PREFIX}${TAG_NAME}"
          echo "üß∑ Tag: $TAG_NAME"
          echo "üîñ Fix Version: $FIX_VERSION"

          # ÂèñÂæó tag Â∞çÊáâÁöÑ commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "üìÑ Commit message: $COMMIT_MSG"

          # Êì∑Âèñ Jira issue keys
          ISSUE_KEYS=$(echo "$COMMIT_MSG" | grep -oE '[A-Z]+-[0-9]+' | sort -u)

          if [ -z "$ISSUE_KEYS" ]; then
            echo "‚ö†Ô∏è No Jira issue keys found in commit message. Exiting."
            exit 0
          fi

          for ISSUE_KEY in $ISSUE_KEYS; do
            echo "üîß Updating $ISSUE_KEY to fixVersion: $FIX_VERSION"

            PROJECT_KEY="${ISSUE_KEY%%-*}"

            # Âª∫Á´ãÁâàÊú¨ÔºàÁÑ°Ë¶ñÂ§±ÊïóÔºâ
            curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X POST \
              -H "Content-Type: application/json" \
              --data "{\"name\":\"$FIX_VERSION\",\"project\":\"$PROJECT_KEY\"}" \
              "$JIRA_BASE_URL/rest/api/3/version" > /dev/null

            # Êõ¥Êñ∞ Fix Version Ê¨Ñ‰Ωç
            curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X PUT \
              -H "Content-Type: application/json" \
              --data "{\"fields\":{\"fixVersions\":[{\"name\":\"$FIX_VERSION\"}]}}" \
              "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY"

            echo "‚úÖ Updated $ISSUE_KEY"
          done
